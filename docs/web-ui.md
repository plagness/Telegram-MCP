# Web-UI (Telegram Mini App)

–ú–æ–¥—É–ª—å `tgweb` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, –æ—Ç–∫—Ä—ã–≤–∞–µ–º—ã—Ö –≤–Ω—É—Ç—Ä–∏ Telegram –∫–∞–∫ Mini App (TWA).

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–í–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã**: —Å–æ–∑–¥–∞–Ω–∏–µ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
- **–û–ø—Ä–æ—Å–Ω–∏–∫–∏**: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã —Å –ø–æ–ª—è–º–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **Prediction Markets**: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π (Polymarket-style) —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏ –∏ —Å—É–º–º–æ–π
- **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞
- **Telegram initData**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ HMAC-SHA256
- **TON Connect**: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è TON-–ø–ª–∞—Ç–µ–∂–µ–π
- **Stars Payments**: –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ `Telegram.WebApp.openInvoice()`
- **Direct Link Mini App**: –∫–Ω–æ–ø–∫–∏ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –æ—Ç–∫—Ä—ã–≤–∞—é—Ç Mini App –≤–Ω—É—Ç—Ä–∏ Telegram
- **–ö–∞–ª–µ–Ω–¥–∞—Ä—å**: –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π —Å –ø–æ–∏—Å–∫–æ–º, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, —ç–º–æ–¥–∑–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram Mini App  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  VPS (TCP proxy)     ‚îÇ
‚îÇ  (t.me/Bot/app)     ‚îÇ     ‚îÇ  socat :8443         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ Tailscale
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  tgapi (proxy)      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  tgweb (FastAPI)     ‚îÇ
‚îÇ  /v1/web/*          ‚îÇ     ‚îÇ  uvicorn + TLS :8443 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ direct DB
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  tgmcp              ‚îÇ     ‚îÇ  PostgreSQL          ‚îÇ
‚îÇ  MCP webui.*        ‚îÇ     ‚îÇ  (:5436)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------|------------|
| **tgweb** | 8443 | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü, –ø—Ä–∏—ë–º —Ñ–æ—Ä–º, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (TLS) |
| **tgapi** | 8081 | Proxy `/v1/web/*` -> `tgweb/api/v1/*` |
| **tgmcp** | 3335 | MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã `webui.*` |

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Let's Encrypt)

Web-UI —Ç—Ä–µ–±—É–µ—Ç HTTPS. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ DNS-01 challenge:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot
pip install certbot

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (DNS-01 ‚Äî —Ä—É—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è)
certbot certonly \
  --manual \
  --preferred-challenges dns \
  --config-dir ~/.certbot/config \
  --work-dir ~/.certbot/work \
  --logs-dir ~/.certbot/logs \
  -d tg.example.com \
  -d telegram.example.com

# certbot –ø–æ–∫–∞–∂–µ—Ç TXT-–∑–∞–ø–∏—Å—å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DNS:
#   _acme-challenge.tg.example.com -> <–∑–Ω–∞—á–µ–Ω–∏–µ>
# –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å —É –≤–∞—à–µ–≥–æ DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ.

# –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ ~/.certbot/config/live/tg.example.com/
# Symlinks –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ Docker ‚Äî –∫–æ–ø–∏—Ä—É–µ–º —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º:
mkdir -p ~/.certbot/flat
cp -L ~/.certbot/config/live/tg.example.com/fullchain.pem ~/.certbot/flat/
cp -L ~/.certbot/config/live/tg.example.com/privkey.pem ~/.certbot/flat/
chmod 644 ~/.certbot/flat/*.pem
```

**–ü—Ä–æ–¥–ª–µ–Ω–∏–µ**: —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–µ–π—Å—Ç–≤—É—é—Ç 90 –¥–Ω–µ–π. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ `certbot renew` –∏ `cp -L`.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env

```bash
# Web-UI
WEBUI_ENABLED=true
WEBUI_PUBLIC_URL=https://tg.example.com:8443
WEBUI_BOT_USERNAME=YourBotUsername
WEBUI_APP_NAME=app
PORT_WEBUI=8443
```

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|----------|-------------|
| `WEBUI_ENABLED` | –í–∫–ª—é—á–∏—Ç—å web-ui (Mini App –∫–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ callback) | `false` |
| `WEBUI_PUBLIC_URL` | –ü—É–±–ª–∏—á–Ω—ã–π HTTPS URL web-ui | -- |
| `WEBUI_BOT_USERNAME` | Username –±–æ—Ç–∞ (–¥–ª—è Direct Link `t.me/Bot/app`) | -- |
| `WEBUI_APP_NAME` | Short name Mini App –∏–∑ BotFather | `app` |
| `PORT_WEBUI` | –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç web-ui | `8443` |
| `BOT_TOKEN` / `TELEGRAM_BOT_TOKEN` | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ initData) | -- |
| `DB_DSN` | PostgreSQL connection string | -- |
| `TGAPI_URL` | URL tgapi –¥–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ | `http://tgapi:8000` |

### 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Mini App –≤ BotFather

–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App **–≤–Ω—É—Ç—Ä–∏ Telegram** (–∞ –Ω–µ –≤–æ –≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ):

1. –û—Ç–∫—Ä–æ–π—Ç–µ @BotFather -> `/newapp`
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞
3. **Title**: –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
4. **Description**: –æ–ø–∏—Å–∞–Ω–∏–µ
5. **Web App URL**: `https://tg.example.com:8443`
6. **Short Name**: `app` (–∏–ª–∏ –¥—Ä—É–≥–æ–µ ‚Äî —É–∫–∞–∂–∏—Ç–µ –≤ `WEBUI_APP_NAME`)

–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –±—É–¥—É—Ç –≤–µ—Å—Ç–∏ –Ω–∞ `https://t.me/BotUsername/app?startapp=...` ‚Äî Telegram –æ—Ç–∫—Ä–æ–µ—Ç Mini App –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

> **–í–∞–∂–Ω–æ**: `web_app` —Ç–∏–ø InlineKeyboardButton —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ **–ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö**.
> –î–ª—è **–≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Direct Link (`t.me/Bot/app?startapp=...`),
> –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π `url` –≤ InlineKeyboardButton.

### 4. DNS

–î–æ–º–µ–Ω Mini App –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ A-–∑–∞–ø–∏—Å—å:

```
tg.example.com  A  <–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_IP>
```

### 5. –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø (TCP proxy —á–µ—Ä–µ–∑ Tailscale)

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞ NAT (–Ω–∞–ø—Ä–∏–º–µ—Ä, Raspberry Pi –¥–æ–º–∞), –∞ –ø—É–±–ª–∏—á–Ω—ã–π IP ‚Äî –Ω–∞ VPS –≤ Tailscale —Å–µ—Ç–∏:

```bash
# –ù–∞ VPS —Å –ø—É–±–ª–∏—á–Ω—ã–º IP:
apt install -y socat

# TCP proxy: VPS:8443 -> Pi:8443 (—á–µ—Ä–µ–∑ Tailscale)
nohup socat TCP-LISTEN:8443,fork,reuseaddr TCP:<tailscale_ip>:8443 &

# –î–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ ‚Äî systemd unit:
cat > /etc/systemd/system/tgweb-proxy.service << 'EOF'
[Unit]
Description=TCP proxy for tgweb Mini App
After=network.target tailscaled.service

[Service]
ExecStart=/usr/bin/socat TCP-LISTEN:8443,fork,reuseaddr TCP:<tailscale_ip>:8443
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl enable --now tgweb-proxy
```

### 6. Docker Compose

```yaml
tgweb:
  build:
    context: ./telegram-mcp
    dockerfile: web-ui/Dockerfile
  container_name: tgweb
  env_file: ./telegram-mcp/.env
  depends_on:
    tgapi:
      condition: service_healthy
    tgdb:
      condition: service_healthy
  environment:
    DB_DSN: postgresql://${DB_USER}:${DB_PASSWORD}@tgdb:5432/${DB_NAME}
    TGAPI_URL: http://tgapi:8000
    PUBLIC_URL: ${WEBUI_PUBLIC_URL}
    BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
  volumes:
    - /path/to/certs:/certs:ro
  command: >
    uvicorn app.main:app --host 0.0.0.0 --port 8000
    --ssl-certfile /certs/fullchain.pem
    --ssl-keyfile /certs/privkey.pem
  ports:
    - "${PORT_WEBUI:-8443}:8000"
```

### 7. –ó–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
docker compose up -d tgdb tgapi tgweb tgmcp

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ:
curl -sk https://localhost:8443/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω–æ:
curl -sk https://tg.example.com:8443/health
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Direct Link Mini App

1. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline-–∫–Ω–æ–ø–∫–æ–π:
   ```
   url: https://t.me/BotUsername/app?startapp=predict-42
   ```
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É -> Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App
3. Telegram –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL (`https://tg.example.com:8443/`)
4. `twa.js` —á–∏—Ç–∞–µ—Ç `Telegram.WebApp.initDataUnsafe.start_param` = `"predict-42"`
5. JavaScript —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/p/predict-42`
6. –°–µ—Ä–≤–µ—Ä —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è

## Hub (–≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω)

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ Mini App –±–µ–∑ `start_param`, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç hub ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. `twa.js` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `start_param`
2. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/?initData=...` –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
3. –°–µ—Ä–≤–µ—Ä –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç initData, –ø–æ–ª—É—á–∞–µ—Ç `user_id`
4. `get_accessible_pages(user_id)` —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ `check_page_access()`
5. `group_pages_for_hub(pages)` –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç: –ø–æ —á–∞—Ç–∞–º ‚Üí —Å–∏—Å—Ç–µ–º–Ω—ã–µ ‚Üí –ø—É–±–ª–∏—á–Ω—ã–µ
6. Jinja2 —Ä–µ–Ω–¥–µ—Ä–∏—Ç `hub.html` —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏

**–≠–ª–µ–º–µ–Ω—Ç—ã hub:**
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–≤–∞—Ç–∞—Ä–∫–∞, –∏–º—è, –±–µ–π–¥–∂–∏ —Ä–æ–ª–µ–π)
- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º —Å—Ç—Ä–∞–Ω–∏—Ü
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –∏–∫–æ–Ω–∫–∞–º–∏ —Ç–∏–ø–æ–≤ –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

**–®–∞–±–ª–æ–Ω:** `web-ui/app/templates/hub.html`

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [access-control.md](access-control.md)

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å `access_rules` –≤ config:

```json
{
  "access_rules": {
    "public": false,
    "allowed_users": [123456789],
    "allowed_roles": ["project_owner", "tester"],
    "allowed_chats": [-1001234567890]
  }
}
```

**OR-–ª–æ–≥–∏–∫–∞:** –¥–æ—Å—Ç—É–ø –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.

### API —Ä–æ–ª–µ–π (—á–µ—Ä–µ–∑ tgapi proxy)

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `GET` | `/v1/web/roles` | –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π |
| `GET` | `/v1/web/roles/{user_id}` | –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `POST` | `/v1/web/roles` | –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å |
| `DELETE` | `/v1/web/roles/{user_id}/{role}` | –û—Ç–æ–∑–≤–∞—Ç—å —Ä–æ–ª—å |
| `POST` | `/v1/web/roles/check-access` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø |

---

## –†–µ–µ—Å—Ç—Ä –Ω–æ–¥

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [network.md](network.md)

–†–µ–µ—Å—Ç—Ä –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `config/nodes.json` –∏ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ tgweb –∫–∞–∫ volume.

**API:** `GET /v1/web/nodes` ‚Äî —Ä–µ–µ—Å—Ç—Ä –Ω–æ–¥ (–ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ tgapi).

**–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–∫—Å–∏:** `scripts/setup/vds_proxy.sh` ‚Äî –¥–µ–ø–ª–æ–π socat systemd units –Ω–∞ VDS.

---

## API endpoints

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ tgapi proxy)

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `POST` | `/v1/web/pages` | –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É |
| `GET` | `/v1/web/pages` | –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü |
| `GET` | `/v1/web/pages/{slug}` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã |
| `DELETE` | `/v1/web/pages/{slug}` | –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É |
| `POST` | `/v1/web/pages/{slug}/links` | –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É |
| `GET` | `/v1/web/pages/{slug}/submissions` | –û—Ç–≤–µ—Ç—ã —Ñ–æ—Ä–º—ã |
| `GET` | `/v1/web/roles` | –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π |
| `POST` | `/v1/web/roles` | –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å |
| `DELETE` | `/v1/web/roles/{user_id}/{role}` | –û—Ç–æ–∑–≤–∞—Ç—å —Ä–æ–ª—å |
| `POST` | `/v1/web/roles/check-access` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø |
| `GET` | `/v1/web/nodes` | –†–µ–µ—Å—Ç—Ä –Ω–æ–¥ |

### –ü—É–±–ª–∏—á–Ω—ã–µ (tgweb –Ω–∞–ø—Ä—è–º—É—é)

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `GET` | `/` | Hub (–∫–∞—Ç–∞–ª–æ–≥ —Å—Ç—Ä–∞–Ω–∏—Ü) –∏–ª–∏ start_param redirect |
| `GET` | `/p/{slug}` | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã |
| `GET` | `/l/{token}` | –†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ |
| `POST` | `/p/{slug}/submit` | –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (—Å initData) |
| `GET` | `/health` | Healthcheck |

## –¢–∏–ø—ã —Å—Ç—Ä–∞–Ω–∏—Ü

### calendar -- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π

–¢–∏–ø `calendar` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –º–µ—Å—è—á–Ω–æ–π —Å–µ—Ç–∫–æ–π, —Å–ø–∏—Å–∫–æ–º —Å–æ–±—ã—Ç–∏–π, –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π, –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.

```bash
curl -X POST http://localhost:8081/v1/web/pages \
  -H 'content-type: application/json' \
  -d '{
    "title": "–†–∞–±–æ—á–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
    "page_type": "calendar",
    "slug": "cal-covenant",
    "config": {
      "calendar_id": 1,
      "admin_ids": [123456789],
      "chat_id": -1001234567890
    }
  }'
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config`)**:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `calendar_id` | `int` | ID –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ `calendars` —Ç–∞–±–ª–∏—Ü–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) |
| `admin_ids` | `list[int]` | Telegram user IDs —Å –ø—Ä–∞–≤–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| `chat_id` | `int` | ID —á–∞—Ç–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ —à–∞–ø–∫–µ) |

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:

- **–ú–µ—Å—è—á–Ω–∞—è —Å–µ—Ç–∫–∞** —Å —Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π + –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏—Å–æ–∫
- **–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** —Å–æ–±—ã—Ç–∏—è: —ç–º–æ–¥–∑–∏, –±–µ–π–¥–∂–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, —Å—Ç–∞—Ç—É—Å, AI), –≤—Ä–µ–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–≥–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ
- **–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã**: —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É / –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É / —Ç–µ–≥–∞–º / —Å–æ–∑–¥–∞—Ç–µ–ª—é / —Ç–∏–ø—É –∑–∞–ø–∏—Å–∏ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `data-*` –∞—Ç—Ä–∏–±—É—Ç–∞–º)
- **–¢–∏–ø—ã –∑–∞–ø–∏—Å–µ–π (v3)**: —Å–æ–±—ã—Ç–∏–µ, –∑–∞–¥–∞—á–∞, —Ç—Ä–∏–≥–≥–µ—Ä, –º–æ–Ω–∏—Ç–æ—Ä, –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, —Ä—É—Ç–∏–Ω–∞ ‚Äî –∫–∞–∂–¥—ã–π —Å –∏–∫–æ–Ω–∫–æ–π –∏ —Ü–≤–µ—Ç–æ–º
- **–¢—Ä–∏–≥–≥–µ—Ä—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä—ã**: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ trigger_status (pending/success/failed), tick_count, cost_estimate, source_module
- **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è v3**: —Å–µ–∫—Ü–∏–∏ ¬´–¢–∏–ø + —Ç—Ä–∏–≥–≥–µ—Ä¬ª, ¬´–î–µ–π—Å—Ç–≤–∏–µ¬ª (action JSON), ¬´–†–µ–∑—É–ª—å—Ç–∞—Ç¬ª (result JSON)
- **–≠–º–æ–¥–∑–∏**: –∫–∞–∂–¥–æ–º—É —Å–æ–±—ã—Ç–∏—é –º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —ç–º–æ–¥–∑–∏ (64 —ç–º–æ–¥–∑–∏ –≤ 8 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö)
- **–ê–≤–∞—Ç–∞—Ä–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π**: AI-–º–æ–¥–µ–ª–∏ (Claude, GPT, Gemini, Llama) –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å —Ü–≤–µ—Ç–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏
- **–ê–≤–∞—Ç–∞—Ä–∫–∞ —á–∞—Ç–∞**: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Telegram Bot API `getFile` (–∫—ç—à 1 —á–∞—Å)
- **–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: —Ñ–æ—Ç–æ –∏ –∏–º—è –∏–∑ `Telegram.WebApp.initDataUnsafe.user`
- **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å**: FAB-–∫–Ω–æ–ø–∫–∞, —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –¥–µ–π—Å—Ç–≤–∏—è ¬´–í—ã–ø–æ–ª–Ω–µ–Ω–æ¬ª / ¬´–£–¥–∞–ª–∏—Ç—å¬ª
- **XSS-–∑–∞—â–∏—Ç–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `escapeHtml()`

**–§–æ—Ä–º–∞—Ç `created_by`**:

| –ó–Ω–∞—á–µ–Ω–∏–µ | –¢–∏–ø | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
|----------|-----|-------------|
| `admin:{user_id}` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | üë§ —Å–∏–Ω–∏–π (#4A90D9) |
| `ai:claude` | –ù–µ–π—Ä–æ—Å–µ—Ç—å | ü§ñ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (#7C3AED) |
| `ai:gpt` | –ù–µ–π—Ä–æ—Å–µ—Ç—å | üß† –∑–µ–ª—ë–Ω—ã–π (#10A37F) |
| `ai:gemini` | –ù–µ–π—Ä–æ—Å–µ—Ç—å | ‚ú® —Å–∏–Ω–∏–π (#4285F4) |
| `ai:llama` | –ù–µ–π—Ä–æ—Å–µ—Ç—å | ü¶ô —Å–∏–Ω–∏–π (#0084FF) |
| `null` | –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ | üë§ —Å–µ—Ä—ã–π (#9E9E9E) |

**–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** (—á–µ—Ä–µ–∑ tgweb, —Å initData –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π):

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| `POST` | `/p/{slug}/calendar/entries` | –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ |
| `PUT` | `/p/{slug}/calendar/entries/{id}` | –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ |
| `POST` | `/p/{slug}/calendar/entries/{id}/status` | –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å |
| `DELETE` | `/p/{slug}/calendar/entries/{id}` | –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ |

**–ë–î –º–∏–≥—Ä–∞—Ü–∏—è**: `db/init/11_calendar.sql`

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `calendars` | –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ (name, owner, metadata) |
| `calendar_entries` | –°–æ–±—ã—Ç–∏—è (title, description, emoji, start_at, end_at, priority, status, tags, created_by, ai_actionable, entry_type, trigger_at, trigger_status, action, result, source_module, cost_estimate, tick_interval, next_tick_at, tick_count, max_ticks, expires_at) |
| `calendar_history` | –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (action, changes, performed_by) |

### page -- –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

```bash
curl -X POST http://localhost:8081/v1/web/pages \
  -H 'content-type: application/json' \
  -d '{
    "title": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
    "page_type": "page",
    "config": {
      "content_html": "<h2>–ü—Ä–∏–≤–µ—Ç!</h2><p>–≠—Ç–æ –¥–µ–º–æ-—Å—Ç—Ä–∞–Ω–∏—Ü–∞.</p>",
      "buttons": [
        {"text": "–ü–µ—Ä–µ–π—Ç–∏", "url": "https://example.com"}
      ]
    }
  }'
```

### survey -- –û–ø—Ä–æ—Å–Ω–∏–∫

```bash
curl -X POST http://localhost:8081/v1/web/pages \
  -H 'content-type: application/json' \
  -d '{
    "title": "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å",
    "page_type": "survey",
    "config": {
      "fields": [
        {"name": "rating", "type": "select", "label": "–û—Ü–µ–Ω–∫–∞", "options": ["1", "2", "3", "4", "5"]},
        {"name": "comment", "type": "textarea", "label": "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"}
      ]
    }
  }'
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –ø–æ–ª–µ–π: `text`, `textarea`, `number`, `select`, `radio`, `checkbox`.

### prediction -- –†—ã–Ω–æ–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π

```bash
curl -X POST http://localhost:8081/v1/web/pages \
  -H 'content-type: application/json' \
  -d '{
    "title": "–ö—Ç–æ –≤—ã–∏–≥—Ä–∞–µ—Ç?",
    "page_type": "prediction",
    "slug": "predict-42",
    "event_id": 42,
    "config": {}
  }'
```

–ü—Ä–∏ `WEBUI_ENABLED=true` –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–Ω–æ–ø–∫—É Mini App –≤–º–µ—Å—Ç–æ callback.

## –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏

–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

```bash
curl -X POST http://localhost:8081/v1/web/pages/my-survey/links \
  -H 'content-type: application/json' \
  -d '{"user_id": 777, "metadata": {"source": "private_message"}}'

# –û—Ç–≤–µ—Ç: {"token": "a1b2c3d4...", "url": "https://tg.example.com:8443/l/a1b2c3d4..."}
```

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### Telegram initData (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–∫ Mini App, Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç `initData` -- –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ê–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
1. –ü–∞—Ä—Å–∏–Ω–≥ `init_data` –∫–∞–∫ query string
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `hash`, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ `data_check_string` (sorted `key=value`, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ `\n`)
3. `secret_key = HMAC-SHA256("WebAppData", bot_token)`
4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ `HMAC-SHA256(data_check_string, secret_key)` —Å `hash`
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ `auth_date` –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤

> –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ `BOT_TOKEN` –∏–ª–∏ `TELEGRAM_BOT_TOKEN` (fallback).
> –í –º—É–ª—å—Ç–∏–±–æ—Ç-—Å–∏—Å—Ç–µ–º–µ initData –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–æ–º —Ç–æ–≥–æ –±–æ—Ç–∞,
> —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç Mini App.

### TON Connect (–∫–æ—à–µ–ª–µ–∫)

–î–ª—è TON-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª—ë–∫ —á–µ—Ä–µ–∑ TON Connect UI.

### Stars Payments

–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars:
1. –ë—ç–∫–µ–Ω–¥ —Å–æ–∑–¥–∞–µ—Ç invoice —á–µ—Ä–µ–∑ `tgapi /v1/stars/invoice`
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç `Telegram.WebApp.openInvoice(url, callback)`
3. –ü—Ä–∏ `status === 'paid'` -- –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º

## MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `webui.create_page` | –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (page/survey/prediction/calendar) |
| `webui.list_pages` | –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü |
| `webui.create_link` | –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É |
| `webui.get_submissions` | –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —Ñ–æ—Ä–º—ã |
| `webui.create_prediction` | –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (shortcut) |
| `webui.create_survey` | –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å–Ω–∏–∫ (shortcut) |
| `webui.list_roles` | –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `user_id`) |
| `webui.grant_role` | –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å |
| `webui.revoke_role` | –û—Ç–æ–∑–≤–∞—Ç—å —Ä–æ–ª—å |
| `webui.check_access` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ |

## SDK –º–µ—Ç–æ–¥—ã

```python
from telegram_api_client import TelegramAPI

async with TelegramAPI("http://localhost:8081") as api:
    # –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
    page = await api.create_web_page(
        title="–ú–æ–π –æ–ø—Ä–æ—Å", page_type="survey",
        config={"fields": [{"name": "q1", "type": "text", "label": "–í–æ–ø—Ä–æ—Å"}]}
    )

    # –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü
    pages = await api.list_web_pages()

    # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
    link = await api.create_web_link("my-survey", user_id=777)

    # –û—Ç–≤–µ—Ç—ã
    submissions = await api.get_web_submissions("my-survey")

    # Shortcut: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    pred_page = await api.create_prediction_page(event_id=42)

    # Shortcut: –æ–ø—Ä–æ—Å–Ω–∏–∫
    survey = await api.create_survey_page(
        title="–§–∏–¥–±—ç–∫",
        fields=[
            {"name": "rating", "type": "select", "label": "–û—Ü–µ–Ω–∫–∞", "options": ["1-5"]},
            {"name": "text", "type": "textarea", "label": "–¢–µ–∫—Å—Ç"}
        ]
    )
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ú–∏–≥—Ä–∞—Ü–∏–∏: `db/init/10_web_ui.sql`, `db/init/11_calendar.sql`, `db/init/12_access_control.sql`

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `web_pages` | –°—Ç—Ä–∞–Ω–∏—Ü—ã (slug, type, config, template) |
| `web_page_links` | –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (token -> page + user) |
| `web_form_submissions` | –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ñ–æ—Ä–º—ã (data JSONB) |
| `web_wallet_links` | –ü—Ä–∏–≤—è–∑–∫–∞ TON-–∫–æ—à–µ–ª—å–∫–æ–≤ –∫ Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞–º |
| `calendars` | –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ (11_calendar.sql) |
| `calendar_entries` | –°–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (11_calendar.sql) |
| `calendar_history` | –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è (11_calendar.sql) |
| `user_roles` | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (12_access_control.sql) |

> –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î.
> –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î: `psql -U telegram -d telegram < db/init/12_access_control.sql`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
web-ui/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py          # FastAPI + Jinja2 + static + lifespan
‚îÇ   ‚îú‚îÄ‚îÄ config.py        # Settings: PUBLIC_URL, TGAPI_URL, BOT_TOKEN
‚îÇ   ‚îú‚îÄ‚îÄ db.py            # PostgreSQL pool (psycopg)
‚îÇ   ‚îú‚îÄ‚îÄ auth.py          # Telegram initData HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.py    # GET /health
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icons.py     # SVG –∏–∫–æ–Ω–∫–∏ (3300+ –±—Ä–µ–Ω–¥–æ–≤)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages.py     # CRUD API –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ render.py    # GET /, GET /p/{slug}, GET /l/{token}, POST submit, hub
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roles.py     # REST API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ access.py    # check_page_access(), get_accessible_pages()
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ links.py     # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodes.py     # –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∫—ç—à —Ä–µ–µ—Å—Ç—Ä–∞ –Ω–æ–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages.py     # CRUD web_pages –≤ –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roles.py     # CRUD –¥–ª—è user_roles
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.html           # Base —Å telegram-web-app.js SDK
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hub.html            # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (–∫–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error.html          # –û—à–∏–±–∫–∏ (404, 403)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar.html       # –ö–∞–ª–µ–Ω–¥–∞—Ä—å (—Å–µ—Ç–∫–∞, –ø–æ–∏—Å–∫, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è, —ç–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar_event.html # –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–±—ã—Ç–∏—è (include)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prediction.html     # Polymarket UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ survey.html         # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.html           # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ       ‚îú‚îÄ‚îÄ style.css    # Telegram theme (--tg-theme-* CSS vars)
‚îÇ       ‚îú‚îÄ‚îÄ twa.js       # TWA bootstrap + start_param redirect + TON Connect
‚îÇ       ‚îî‚îÄ‚îÄ tonconnect-manifest.json
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ requirements.txt
```

## Troubleshooting

### Mini App –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä –≤–º–µ—Å—Ç–æ Telegram

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Mini App –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `/newapp` –≤ BotFather
- URL –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://t.me/BotUsername/app?startapp=...` (–Ω–µ –ø—Ä—è–º–æ–π URL)
- `web_app` —Ç–∏–ø InlineKeyboardButton —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö**

### –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Mini App

- **–ü–æ—Ä—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å socat –Ω–∞ VPS**. socat –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–∞ `<tailscale_ip>:8443`,
  –∞ `compose.yml` –º–∞–ø–ø–∏—Ç –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 8090). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
  ```bash
  ss -tlnp | grep 8443   # –¥–æ–ª–∂–µ–Ω —Å–ª—É—à–∞—Ç—å
  docker port tgweb       # –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å 8443
  ```
  –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤ `compose.yml` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `"${PORT_WEBUI:-8443}:8000"`
  —Å `command` –≤–∫–ª—é—á–∞—é—â–∏–º `--ssl-certfile` –∏ `--ssl-keyfile`.

- **SSL –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ compose.yml**. tgweb **–æ–±—è–∑–∞–Ω** –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å TLS,
  –∏–Ω–∞—á–µ socat –ø—Ä–æ–±—Ä–æ—Å–∏—Ç TCP, –Ω–æ TLS handshake –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è (–æ—à–∏–±–∫–∞ `unexpected eof`).
  –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ compose.yml:
  ```yaml
  volumes:
    - ${HOME}/.certbot/flat:/certs:ro
  command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000",
            "--ssl-certfile", "/certs/fullchain.pem", "--ssl-keyfile", "/certs/privkey.pem"]
  ports:
    - "${PORT_WEBUI:-8443}:8000"
  ```

- **–î–æ–º–µ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞**. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS (A-–∑–∞–ø–∏—Å—å) –∏ –ø–æ—Ä—Ç (firewall, NAT)
- **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π**. Telegram —Ç—Ä–µ–±—É–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π HTTPS (Let's Encrypt –ø–æ–¥—Ö–æ–¥–∏—Ç)
- **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: `curl -sk -v https://tg.example.com:8443/health` ‚Äî –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å
  `{"status":"ok","service":"tgweb"}`. –ï—Å–ª–∏ `unexpected eof` ‚Äî –Ω–µ—Ç TLS –Ω–∞ tgweb.
  –ï—Å–ª–∏ `Connection refused` ‚Äî –ø–æ—Ä—Ç –Ω–µ —Å–ª—É—à–∞–µ—Ç.

### "Invalid initData" –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã

- `BOT_TOKEN` / `TELEGRAM_BOT_TOKEN` –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–æ—Ç—É Mini App
- –í –º—É–ª—å—Ç–∏–±–æ—Ç-—Å–∏—Å—Ç–µ–º–µ initData –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–æ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `docker exec tgweb printenv TELEGRAM_BOT_TOKEN`

### "Page not found" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `predict-{event_id}` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –≤ `web_pages`
- –°–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ API: `POST /v1/web/pages {"slug": "predict-42", "page_type": "prediction", "event_id": 42, ...}`
