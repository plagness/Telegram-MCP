{% extends "base.html" %}

{% block title %}{{ calendar.title if calendar else page.title }}{% endblock %}

{% block bar_left %}<a class="bee-bar__back" href="/">&#8249;</a>{% endblock %}

{% block context %}
{# ‚îÄ‚îÄ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π —á–∞—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="bee-card bee-hex-bg">
    {% if chat_info %}
    <div class="bee-cal-header">
        <div class="bee-cal-avatar">
            {% if chat_photo_url %}
            <img src="{{ chat_photo_url }}" alt="" class="bee-cal-avatar-img"
                 onerror="this.style.display='none';this.nextElementSibling.style.display=''">
            <span class="bee-cal-avatar-initials" style="display:none">{{ chat_info.title[:2] | upper }}</span>
            {% else %}
            <span class="bee-cal-avatar-initials">{{ chat_info.title[:2] | upper }}</span>
            {% endif %}
        </div>
        <div class="bee-cal-header-text">
            <div class="bee-title" style="margin-bottom:2px">{{ chat_info.title }}</div>
            {% if chat_info.member_count %}
            <span class="bee-badge" style="font-size:11px;padding:2px 8px">{{ chat_info.member_count }} —É—á.</span>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bee-title">{{ calendar.title if calendar else page.title }}</div>
    {% endif %}
    {% if calendar and calendar.description %}
    <div class="bee-subtitle" style="margin-top:6px">{{ calendar.description }}</div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
{# ‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ + –ü–æ–∏—Å–∫ + –ù–∞–≤–∏–≥–∞—Ü–∏—è + –°–µ—Ç–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="bee-card">
    <div class="bee-cal-toggle">
        <button class="bee-cal-toggle-btn active" id="btn-month">–ú–µ—Å—è—Ü</button>
        <button class="bee-cal-toggle-btn" id="btn-list">–°–ø–∏—Å–æ–∫</button>
    </div>

    {# –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ #}
    <button class="bee-cal-search-btn" id="search-open">
        <span>&#128269;</span>
        <span>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã...</span>
        <span class="bee-cal-search-count hidden" id="search-count">0</span>
    </button>

    {# –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º #}
    <div class="bee-cal-nav">
        <a class="bee-cal-nav-btn" href="?month={{ prev_month_param }}">&larr;</a>
        <div class="bee-cal-nav-title">{{ month_title }}</div>
        <a class="bee-cal-nav-btn" href="?month={{ next_month_param }}">&rarr;</a>
    </div>

    {# –°–µ—Ç–∫–∞ –º–µ—Å—è—Ü–∞ #}
    <div id="month-view">
        <div class="bee-cal-grid">
            {% for wd in weekdays %}
            <div class="bee-cal-weekday">{{ wd }}</div>
            {% endfor %}

            {% for week in grid_weeks %}
            {% for cell in week %}
            <div class="bee-cal-day{% if cell.other %} bee-cal-day--other{% endif %}{% if cell.is_today %} bee-cal-day--today{% endif %}{% if cell.events %} bee-cal-day--has-events{% endif %}{% if selected_day == cell.date_key %} bee-cal-day--selected{% endif %}"
                 {% if not cell.other and cell.date_key %}data-date="{{ cell.date_key }}"{% endif %}>
                <span>{{ cell.day }}</span>
                {% if cell.events %}
                <div class="bee-cal-dots">
                    {% for e in cell.events[:4] %}
                    <div class="bee-cal-dot" style="background:{% if e.entry_type and e.entry_type != 'event' %}{{ e._entry_type_color }}{% else %}{{ e._color }}{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    {# –°–ø–∏—Å–æ–∫ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) #}
    <div id="list-view" class="hidden">
        {% if entries_grouped %}
        {% for group in entries_grouped %}
        <div class="bee-cal-date-header">{{ group.date_label }}</div>
        {% for e in group.entries %}
        {% include "calendar_event.html" %}
        {% endfor %}
        {% endfor %}
        {% else %}
        <div class="bee-cal-empty">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>
        {% endif %}
    </div>
</div>

{# ‚îÄ‚îÄ –ü–∞–Ω–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–Ω—è–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
{% for dk, panel in day_panels.items() %}
<div class="bee-card hidden day-panel" data-date="{{ dk }}"{% if selected_day == dk %} style="display:block"{% endif %}>
    <div class="bee-cal-detail">
        <div class="bee-cal-detail-header">{{ panel.date_label }}</div>
        {% for e in panel.entries %}
        {% include "calendar_event.html" %}
        {% endfor %}
    </div>
</div>
{% endfor %}

{# –ü—É—Å—Ç–æ–π –¥–µ–Ω—å #}
<div class="bee-card hidden" id="empty-day">
    <div class="bee-cal-detail">
        <div class="bee-cal-detail-header" id="empty-day-date"></div>
        <div class="bee-cal-empty">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>
    </div>
</div>

{# ‚îÄ‚îÄ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è v5 ‚Äî —Å–µ–∫—Ü–∏–∏ —Å –∫–æ–ª–ª–∞–ø—Å–∞–º–∏ ‚îÄ‚îÄ #}
<div class="bee-cal-fulldetail hidden" id="fulldetail">
    <div class="bee-cal-fulldetail-bar" id="fd-bar"></div>
    <button class="bee-cal-fulldetail-close" id="fd-close">&#10005;</button>
    <div class="bee-cal-fulldetail-content">
        {# Header (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω) #}
        <div class="bee-cal-fulldetail-header">
            <div class="bee-cal-fulldetail-emoji" id="fd-emoji"></div>
            <div class="bee-cal-fulldetail-title" id="fd-title"></div>
        </div>
        <div id="fd-type-card"></div>

        {# –°—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω) #}
        <div class="bee-fd-fixed" id="fd-status-time">
            <div class="bee-cal-fulldetail-badges" id="fd-badges"></div>
            <div class="bee-cal-fulldetail-time" id="fd-time"></div>
            <div id="fd-trigger-at"></div>
            <div id="fd-tick-info"></div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –û–ø–∏—Å–∞–Ω–∏–µ (—Ä–∞—Å–∫—Ä—ã—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-desc" data-default="expanded">
            <button class="bee-fd-section__header" aria-expanded="true">
                <span class="bee-fd-section__icon">&#128196;</span>
                <span class="bee-fd-section__title">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body">
                <div class="bee-cal-fulldetail-desc" id="fd-desc"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –¢–µ–≥–∏ (—Ä–∞—Å–∫—Ä—ã—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-tags" data-default="expanded">
            <button class="bee-fd-section__header" aria-expanded="true">
                <span class="bee-fd-section__icon">&#127991;</span>
                <span class="bee-fd-section__title">–¢–µ–≥–∏</span>
                <span class="bee-fd-section__count hidden" id="fd-tags-count"></span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body">
                <div class="bee-fd-tags" id="fd-tags"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –ú–µ—Ç—Ä–∏–∫–∏ / –í–∏–¥–∂–µ—Ç—ã (—Ä–∞—Å–∫—Ä—ã—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-widgets" data-default="expanded">
            <button class="bee-fd-section__header" aria-expanded="true">
                <span class="bee-fd-section__icon">&#128202;</span>
                <span class="bee-fd-section__title">–ú–µ—Ç—Ä–∏–∫–∏</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body">
                <div class="bee-fd-widgets" id="fd-widgets"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –ê–≤—Ç–æ—Ä (—Ä–∞—Å–∫—Ä—ã—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-creator" data-default="expanded">
            <button class="bee-fd-section__header" aria-expanded="true">
                <span class="bee-fd-section__icon">&#128100;</span>
                <span class="bee-fd-section__title">–ê–≤—Ç–æ—Ä</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body">
                <div class="bee-cal-fulldetail-creator" id="fd-creator"></div>
                <div id="fd-cost-source"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –î–µ–π—Å—Ç–≤–∏–µ (—Å–≤—ë—Ä–Ω—É—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-action" data-default="collapsed">
            <button class="bee-fd-section__header" aria-expanded="false">
                <span class="bee-fd-section__icon">&#9881;&#65039;</span>
                <span class="bee-fd-section__title">–î–µ–π—Å—Ç–≤–∏–µ</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body" style="display:none">
                <div class="bee-fd-json" id="fd-action"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –†–µ–∑—É–ª—å—Ç–∞—Ç (—Å–≤—ë—Ä–Ω—É—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-result" data-default="collapsed">
            <button class="bee-fd-section__header" aria-expanded="false">
                <span class="bee-fd-section__icon">&#128200;</span>
                <span class="bee-fd-section__title">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body" style="display:none">
                <div class="bee-fd-json" id="fd-result"></div>
            </div>
        </div>

        {# –°–µ–∫—Ü–∏—è: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å–≤—ë—Ä–Ω—É—Ç–∞) #}
        <div class="bee-fd-section hidden" id="fd-section-meta" data-default="collapsed">
            <button class="bee-fd-section__header" aria-expanded="false">
                <span class="bee-fd-section__icon">&#128295;</span>
                <span class="bee-fd-section__title">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ</span>
                <span class="bee-fd-section__chevron">&#9662;</span>
            </button>
            <div class="bee-fd-section__body" style="display:none">
                <div class="bee-fd-meta" id="fd-meta"></div>
            </div>
        </div>

        {# Admin actions (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω) #}
        <div class="bee-cal-fulldetail-actions hidden" id="fd-admin">
            <button class="bee-btn" id="fd-done-btn">&#10003; –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
            <button class="bee-btn bee-btn--danger" id="fd-delete-btn">&#10005; –£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

{# ‚îÄ‚îÄ –ü–æ–∏—Å–∫ / —Ñ–∏–ª—å—Ç—Ä—ã (fullscreen overlay) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
<div class="bee-cal-search-overlay hidden" id="search-overlay">
    <div class="bee-cal-search-header">
        <input type="text" class="bee-input" id="search-text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é...">
        <button class="bee-cal-search-close" id="search-close">&#10005;</button>
    </div>

    <div class="bee-cal-search-section">
        <div class="bee-cal-search-section-title">–¢–∏–ø</div>
        <div class="bee-cal-search-pills" id="search-entry-type">
            <button class="bee-cal-search-pill bee-cal-search-pill--active" data-val="all">–í—Å–µ</button>
            <button class="bee-cal-search-pill" data-val="event">&#128197; –°–æ–±—ã—Ç–∏—è</button>
            <button class="bee-cal-search-pill" data-val="trigger">&#128276; –¢—Ä–∏–≥–≥–µ—Ä—ã</button>
            <button class="bee-cal-search-pill" data-val="monitor">&#128225; –ú–æ–Ω–∏—Ç–æ—Ä—ã</button>
            <button class="bee-cal-search-pill" data-val="task">&#128221; –ó–∞–¥–∞—á–∏</button>
        </div>
    </div>

    <div class="bee-cal-search-section">
        <div class="bee-cal-search-section-title">–°—Ç–∞—Ç—É—Å</div>
        <div class="bee-cal-search-pills" id="search-status">
            <button class="bee-cal-search-pill bee-cal-search-pill--active" data-val="all">–í—Å–µ</button>
            <button class="bee-cal-search-pill" data-val="active">–ê–∫—Ç–∏–≤–Ω–æ</button>
            <button class="bee-cal-search-pill" data-val="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
            <button class="bee-cal-search-pill" data-val="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</button>
        </div>
    </div>

    <div class="bee-cal-search-section">
        <div class="bee-cal-search-section-title">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
        <div class="bee-cal-search-pills" id="search-priority">
            <button class="bee-cal-search-pill bee-cal-search-pill--active" data-val="all">–í—Å–µ</button>
            <button class="bee-cal-search-pill" data-val="5" style="border-color:#E74C3C">&#9679; –ö—Ä–∏—Ç–∏—á–Ω—ã–π</button>
            <button class="bee-cal-search-pill" data-val="4" style="border-color:#E67E22">&#9679; –í—ã—Å–æ–∫–∏–π</button>
            <button class="bee-cal-search-pill" data-val="3" style="border-color:#FFC107">&#9679; –°—Ä–µ–¥–Ω–∏–π</button>
            <button class="bee-cal-search-pill" data-val="2" style="border-color:#2ECC71">&#9679; –û–±—ã—á–Ω—ã–π</button>
            <button class="bee-cal-search-pill" data-val="1" style="border-color:#95A5A6">&#9679; –ù–∏–∑–∫–∏–π</button>
        </div>
    </div>

    {% if all_tags %}
    <div class="bee-cal-search-section">
        <div class="bee-cal-search-section-title">–¢–µ–≥–∏</div>
        <div class="bee-cal-search-tags" id="search-tags">
            {% for tag in all_tags %}
            {% set tc = tag_colors.get(tag.lower(), 'var(--tg-hint)') if tag_colors else 'var(--tg-hint)' %}
            <div class="bee-cal-search-tag-item" data-tag="{{ tag | lower }}">
                <div class="bee-cal-search-tag-check">&#10003;</div>
                <span style="color:{{ tc }}">&#9679;</span>
                <span>{{ tag }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="bee-cal-search-section">
        <div class="bee-cal-search-section-title">–°–æ–∑–¥–∞—Ç–µ–ª—å</div>
        <div class="bee-cal-search-pills" id="search-creator">
            <button class="bee-cal-search-pill bee-cal-search-pill--active" data-val="all">–í—Å–µ</button>
            <button class="bee-cal-search-pill" data-val="user">&#128100; –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="bee-cal-search-pill" data-val="ai">&#129302; –ù–µ–π—Ä–æ—Å–µ—Ç–∏</button>
        </div>
    </div>

    <div class="bee-cal-search-actions">
        <button class="bee-btn" id="search-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="bee-btn bee-btn--outline" id="search-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
</div>

{# ‚îÄ‚îÄ –≠–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
{% if is_admin %}
<div class="bee-cal-emoji-overlay hidden" id="emoji-overlay">
    <div class="bee-cal-emoji-sheet" onclick="event.stopPropagation()">
        <div class="bee-cal-emoji-cat">&#128197; –í—Ä–µ–º—è</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üìÖ">üìÖ</button>
            <button class="bee-cal-emoji-item" data-e="üóìÔ∏è">üóìÔ∏è</button>
            <button class="bee-cal-emoji-item" data-e="‚è∞">‚è∞</button>
            <button class="bee-cal-emoji-item" data-e="‚è≥">‚è≥</button>
            <button class="bee-cal-emoji-item" data-e="üîî">üîî</button>
            <button class="bee-cal-emoji-item" data-e="üìÜ">üìÜ</button>
            <button class="bee-cal-emoji-item" data-e="üïê">üïê</button>
            <button class="bee-cal-emoji-item" data-e="üåô">üåô</button>
        </div>

        <div class="bee-cal-emoji-cat">&#128188; –†–∞–±–æ—Ç–∞</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üíº">üíº</button>
            <button class="bee-cal-emoji-item" data-e="üìä">üìä</button>
            <button class="bee-cal-emoji-item" data-e="üíª">üíª</button>
            <button class="bee-cal-emoji-item" data-e="üîß">üîß</button>
            <button class="bee-cal-emoji-item" data-e="‚öôÔ∏è">‚öôÔ∏è</button>
            <button class="bee-cal-emoji-item" data-e="üìù">üìù</button>
            <button class="bee-cal-emoji-item" data-e="‚úèÔ∏è">‚úèÔ∏è</button>
            <button class="bee-cal-emoji-item" data-e="üìã">üìã</button>
        </div>

        <div class="bee-cal-emoji-cat">&#128101; –õ—é–¥–∏</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üë•">üë•</button>
            <button class="bee-cal-emoji-item" data-e="ü§ù">ü§ù</button>
            <button class="bee-cal-emoji-item" data-e="üí¨">üí¨</button>
            <button class="bee-cal-emoji-item" data-e="üìû">üìû</button>
            <button class="bee-cal-emoji-item" data-e="üé§">üé§</button>
            <button class="bee-cal-emoji-item" data-e="üë§">üë§</button>
            <button class="bee-cal-emoji-item" data-e="üßë‚Äçüíª">üßë‚Äçüíª</button>
            <button class="bee-cal-emoji-item" data-e="üì£">üì£</button>
        </div>

        <div class="bee-cal-emoji-cat">&#127919; –¶–µ–ª–∏</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üéØ">üéØ</button>
            <button class="bee-cal-emoji-item" data-e="üèÜ">üèÜ</button>
            <button class="bee-cal-emoji-item" data-e="‚≠ê">‚≠ê</button>
            <button class="bee-cal-emoji-item" data-e="üöÄ">üöÄ</button>
            <button class="bee-cal-emoji-item" data-e="üí°">üí°</button>
            <button class="bee-cal-emoji-item" data-e="üî•">üî•</button>
            <button class="bee-cal-emoji-item" data-e="‚úÖ">‚úÖ</button>
            <button class="bee-cal-emoji-item" data-e="‚ùå">‚ùå</button>
        </div>

        <div class="bee-cal-emoji-cat">&#128193; –§–∞–π–ª—ã</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üìÅ">üìÅ</button>
            <button class="bee-cal-emoji-item" data-e="üìÇ">üìÇ</button>
            <button class="bee-cal-emoji-item" data-e="üìé">üìé</button>
            <button class="bee-cal-emoji-item" data-e="üîó">üîó</button>
            <button class="bee-cal-emoji-item" data-e="üìÑ">üìÑ</button>
            <button class="bee-cal-emoji-item" data-e="üìë">üìë</button>
            <button class="bee-cal-emoji-item" data-e="üì§">üì§</button>
            <button class="bee-cal-emoji-item" data-e="üì•">üì•</button>
        </div>

        <div class="bee-cal-emoji-cat">&#127881; –ü—Ä–∞–∑–¥–Ω–∏–∫–∏</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üéâ">üéâ</button>
            <button class="bee-cal-emoji-item" data-e="üéÇ">üéÇ</button>
            <button class="bee-cal-emoji-item" data-e="üéä">üéä</button>
            <button class="bee-cal-emoji-item" data-e="üéÅ">üéÅ</button>
            <button class="bee-cal-emoji-item" data-e="ü•≥">ü•≥</button>
            <button class="bee-cal-emoji-item" data-e="üíê">üíê</button>
            <button class="bee-cal-emoji-item" data-e="üçï">üçï</button>
            <button class="bee-cal-emoji-item" data-e="üéà">üéà</button>
        </div>

        <div class="bee-cal-emoji-cat">&#9888;&#65039; –í–∞–∂–Ω–æ</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="‚ö†Ô∏è">‚ö†Ô∏è</button>
            <button class="bee-cal-emoji-item" data-e="üö®">üö®</button>
            <button class="bee-cal-emoji-item" data-e="‚ùó">‚ùó</button>
            <button class="bee-cal-emoji-item" data-e="üî¥">üî¥</button>
            <button class="bee-cal-emoji-item" data-e="üü°">üü°</button>
            <button class="bee-cal-emoji-item" data-e="üü¢">üü¢</button>
            <button class="bee-cal-emoji-item" data-e="üîµ">üîµ</button>
            <button class="bee-cal-emoji-item" data-e="‚õî">‚õî</button>
        </div>

        <div class="bee-cal-emoji-cat">&#127760; –†–∞–∑–Ω–æ–µ</div>
        <div class="bee-cal-emoji-grid">
            <button class="bee-cal-emoji-item" data-e="üåê">üåê</button>
            <button class="bee-cal-emoji-item" data-e="üè†">üè†</button>
            <button class="bee-cal-emoji-item" data-e="üöó">üöó</button>
            <button class="bee-cal-emoji-item" data-e="‚úàÔ∏è">‚úàÔ∏è</button>
            <button class="bee-cal-emoji-item" data-e="üè•">üè•</button>
            <button class="bee-cal-emoji-item" data-e="üí∞">üí∞</button>
            <button class="bee-cal-emoji-item" data-e="üì±">üì±</button>
            <button class="bee-cal-emoji-item" data-e="üîë">üîë</button>
        </div>

        <div class="bee-cal-emoji-clear" id="emoji-clear">–£–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏</div>
    </div>
</div>
{% endif %}

{# ‚îÄ‚îÄ FAB –¥–ª—è –∞–¥–º–∏–Ω–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
{% if is_admin %}
<button class="bee-cal-fab" id="fab-add">+</button>

{# –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è #}
<div class="bee-cal-modal-overlay hidden" id="modal-overlay">
    <div class="bee-cal-modal" onclick="event.stopPropagation()">
        <div class="bee-cal-modal-title" id="modal-title">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
        <form id="entry-form">
            <input type="hidden" id="entry-id" value="">
            <input type="hidden" id="entry-emoji" value="">

            <div class="bee-field">
                <label class="bee-label">–≠–º–æ–¥–∑–∏</label>
                <button type="button" class="bee-cal-search-btn" id="emoji-trigger" style="margin:0">
                    <span id="emoji-preview">–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏...</span>
                </button>
            </div>

            <div class="bee-field">
                <label class="bee-label">–¢–∏–ø –∑–∞–ø–∏—Å–∏</label>
                <select id="entry-type" class="bee-select">
                    <option value="event">&#128197; –°–æ–±—ã—Ç–∏–µ</option>
                    <option value="task">&#128221; –ó–∞–¥–∞—á–∞</option>
                    <option value="trigger">&#128276; –¢—Ä–∏–≥–≥–µ—Ä</option>
                    <option value="monitor">&#128225; –ú–æ–Ω–∏—Ç–æ—Ä</option>
                </select>
            </div>

            <div class="bee-field">
                <label class="bee-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ <span class="required">*</span></label>
                <input type="text" id="entry-title" class="bee-input" required maxlength="300">
            </div>

            <div class="bee-field">
                <label class="bee-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="entry-desc" class="bee-textarea" rows="3"></textarea>
            </div>

            <div style="display:flex;gap:8px">
                <div class="bee-field" style="flex:1">
                    <label class="bee-label">–ù–∞—á–∞–ª–æ <span class="required">*</span></label>
                    <input type="datetime-local" id="entry-start" class="bee-input" required>
                </div>
                <div class="bee-field" style="flex:1">
                    <label class="bee-label">–ö–æ–Ω–µ—Ü</label>
                    <input type="datetime-local" id="entry-end" class="bee-input">
                </div>
            </div>

            {# –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ #}
            <div class="bee-cal-form-conditional" id="trigger-fields">
                <div class="bee-field">
                    <label class="bee-label">–°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ <span class="required">*</span></label>
                    <input type="datetime-local" id="entry-trigger-at" class="bee-input">
                </div>
            </div>

            {# –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∞ #}
            <div class="bee-cal-form-conditional" id="monitor-fields">
                <div style="display:flex;gap:8px">
                    <div class="bee-field" style="flex:1">
                        <label class="bee-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Ç–∏–∫–æ–≤</label>
                        <select id="entry-tick-interval" class="bee-select">
                            <option value="5m">5 –º–∏–Ω</option>
                            <option value="10m">10 –º–∏–Ω</option>
                            <option value="30m">30 –º–∏–Ω</option>
                            <option value="1h" selected>1 —á–∞—Å</option>
                            <option value="6h">6 —á–∞—Å–æ–≤</option>
                            <option value="1d">1 –¥–µ–Ω—å</option>
                        </select>
                    </div>
                    <div class="bee-field" style="flex:1">
                        <label class="bee-label">–ú–∞–∫—Å. —Ç–∏–∫–æ–≤</label>
                        <input type="number" id="entry-max-ticks" class="bee-input" min="1" max="1000" placeholder="10">
                    </div>
                </div>
            </div>

            <div style="display:flex;gap:8px">
                <div class="bee-field" style="flex:1">
                    <label class="bee-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="entry-priority" class="bee-select">
                        <option value="1">1 ‚Äî –ù–∏–∑–∫–∏–π</option>
                        <option value="2">2 ‚Äî –û–±—ã—á–Ω—ã–π</option>
                        <option value="3" selected>3 ‚Äî –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="4">4 ‚Äî –í—ã—Å–æ–∫–∏–π</option>
                        <option value="5">5 ‚Äî –ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                    </select>
                </div>
                <div class="bee-field" style="flex:1">
                    <label class="bee-label">–°—Ç–∞—Ç—É—Å</label>
                    <select id="entry-status" class="bee-select">
                        <option value="active">–ê–∫—Ç–∏–≤–Ω–æ</option>
                        <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                        <option value="archived">–ê—Ä—Ö–∏–≤</option>
                    </select>
                </div>
            </div>

            <div class="bee-field">
                <label class="bee-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="entry-tags" class="bee-input" placeholder="work, meeting, deadline">
            </div>

            <div class="bee-field">
                <label class="bee-checkbox-label">
                    <input type="checkbox" id="entry-allday"> –í–µ—Å—å –¥–µ–Ω—å
                </label>
            </div>

            <div class="bee-field">
                <label class="bee-checkbox-label">
                    <input type="checkbox" id="entry-ai" checked> AI —Ä–µ–∞–≥–∏—Ä—É–µ—Ç
                </label>
            </div>

            <button type="submit" class="bee-btn mt-8" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function () {
    "use strict";

    var PAGE_SLUG = '{{ page.slug }}';
    var IS_ADMIN = {{ 'true' if is_admin else 'false' }};
    var CALENDAR_ID = {{ calendar_id }};
    var tg = window.Telegram && window.Telegram.WebApp;
    var initData = tg ? tg.initData : '';

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var btnMonth = document.getElementById('btn-month');
    var btnList = document.getElementById('btn-list');
    var monthView = document.getElementById('month-view');
    var listView = document.getElementById('list-view');

    if (btnMonth) btnMonth.onclick = function () {
        monthView.classList.remove('hidden');
        listView.classList.add('hidden');
        btnMonth.classList.add('active');
        btnList.classList.remove('active');
        haptic('selection');
    };
    if (btnList) btnList.onclick = function () {
        monthView.classList.add('hidden');
        listView.classList.remove('hidden');
        btnList.classList.add('active');
        btnMonth.classList.remove('active');
        haptic('selection');
    };

    // ‚îÄ‚îÄ –í—ã–±–æ—Ä –¥–Ω—è –≤ —Å–µ—Ç–∫–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var dayEls = document.querySelectorAll('.bee-cal-day[data-date]');
    var panels = document.querySelectorAll('.day-panel');
    var emptyDay = document.getElementById('empty-day');
    var emptyDayDate = document.getElementById('empty-day-date');

    for (var i = 0; i < dayEls.length; i++) {
        dayEls[i].addEventListener('click', onDayClick);
    }

    function onDayClick() {
        var dk = this.getAttribute('data-date');
        var prev = document.querySelector('.bee-cal-day--selected');
        if (prev) prev.classList.remove('bee-cal-day--selected');
        this.classList.add('bee-cal-day--selected');

        for (var j = 0; j < panels.length; j++) {
            panels[j].classList.add('hidden');
            panels[j].style.display = '';
        }
        if (emptyDay) emptyDay.classList.add('hidden');

        var panel = document.querySelector('.day-panel[data-date="' + dk + '"]');
        if (panel) {
            panel.classList.remove('hidden');
        } else if (emptyDay) {
            if (emptyDayDate) emptyDayDate.textContent = dk;
            emptyDay.classList.remove('hidden');
        }
        haptic('selection');
    }

    // ‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏—è (done/delete) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerAction(action, id) {
        if (action === 'done') {
            fetch('/p/' + PAGE_SLUG + '/calendar/entries/' + id + '/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'done', init_data: initData })
            }).then(function () {
                showToast('–í—ã–ø–æ–ª–Ω–µ–Ω–æ', 'success');
                setTimeout(function () { location.reload(); }, 600);
            });
            haptic('notification', 'success');
        } else if (action === 'delete') {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')) return;
            fetch('/p/' + PAGE_SLUG + '/calendar/entries/' + id, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ init_data: initData })
            }).then(function () {
                showToast('–£–¥–∞–ª–µ–Ω–æ', 'success');
                setTimeout(function () { location.reload(); }, 600);
            });
            haptic('notification', 'warning');
        }
    }

    // ‚îÄ‚îÄ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var fulldetail = document.getElementById('fulldetail');
    var fdClose = document.getElementById('fd-close');

    if (fdClose) fdClose.onclick = function () { fulldetail.classList.add('hidden'); };

    document.addEventListener('click', function (e) {
        var card = e.target.closest('.bee-cal-event--clickable');
        if (!card) return;
        if (e.target.closest('[data-action]')) return;
        if (e.target.closest('.bee-cal-event-tag')) return;
        if (e.target.closest('.bee-cal-event-ava')) return;
        if (e.target.closest('.bee-cal-event-author-names')) return;
        openFullDetail(card);
        haptic('impact', 'light');
    });

    // –ú–∞–ø–ø–∏–Ω–≥ —Ü–≤–µ—Ç–æ–≤ —Ç–∏–ø–æ–≤ –¥–ª—è fulldetail
    var TYPE_COLORS = {
        'event': '#FFC107', 'task': '#10B981', 'trigger': '#F59E0B',
        'monitor': '#3B82F6', 'vote': '#8B5CF6', 'routine': '#6B7280'
    };
    var TYPE_BG = {
        'event': 'rgba(255,193,7,0.08)', 'task': 'rgba(16,185,129,0.08)',
        'trigger': 'rgba(245,158,11,0.08)', 'monitor': 'rgba(59,130,246,0.08)',
        'vote': 'rgba(139,92,246,0.08)', 'routine': 'rgba(107,114,128,0.08)'
    };

    // ‚îÄ‚îÄ v5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–∫—Ü–∏–π (–æ–¥–∏–Ω —Ä–∞–∑) ‚îÄ‚îÄ
    (function initSections() {
        var headers = fulldetail.querySelectorAll('.bee-fd-section__header');
        for (var i = 0; i < headers.length; i++) {
            headers[i].addEventListener('click', function () {
                var section = this.closest('.bee-fd-section');
                var body = section.querySelector('.bee-fd-section__body');
                var expanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !expanded ? 'true' : 'false');
                body.style.display = expanded ? 'none' : '';
                haptic('selection');
            });
        }
    })();

    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∫ default-—Å–æ—Å—Ç–æ—è–Ω–∏—é
    function resetSections() {
        var sections = fulldetail.querySelectorAll('.bee-fd-section');
        for (var i = 0; i < sections.length; i++) {
            var sec = sections[i];
            var def = sec.getAttribute('data-default');
            var header = sec.querySelector('.bee-fd-section__header');
            var body = sec.querySelector('.bee-fd-section__body');
            if (def === 'collapsed') {
                header.setAttribute('aria-expanded', 'false');
                body.style.display = 'none';
            } else {
                header.setAttribute('aria-expanded', 'true');
                body.style.display = '';
            }
            sec.classList.add('hidden');
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é (—É–±—Ä–∞—Ç—å hidden)
    function showSection(id) {
        var el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
    }

    function openFullDetail(card) {
        var d = card.dataset;
        var entryType = d.entryType || 'event';
        var typeColor = TYPE_COLORS[entryType] || '#FFC107';
        var typeBg = TYPE_BG[entryType] || 'rgba(255,193,7,0.08)';

        // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        resetSections();

        // –¶–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ ‚Äî –ø–æ —Ç–∏–ø—É
        document.getElementById('fd-bar').style.background = (entryType !== 'event') ? typeColor : d.color;

        // –≠–º–æ–¥–∑–∏ / Simple Icon + –∑–∞–≥–æ–ª–æ–≤–æ–∫
        var emojiEl = document.getElementById('fd-emoji');
        if (d.iconHas === 'true' && d.iconUrl) {
            // Simple Icon ‚Äî —Ä–µ–Ω–¥–µ—Ä –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É
            emojiEl.innerHTML = '<span class="bee-cal-event-icon-inline" style="background:' + escapeHtml(d.iconColor) + ';width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center">'
                + '<img src="' + escapeHtml(d.iconUrl) + '" alt="" width="24" height="24" loading="lazy" style="filter:brightness(0) invert(1)">'
                + '</span>';
            emojiEl.style.display = '';
        } else if (entryType !== 'event' && !d.emoji) {
            emojiEl.textContent = d.entryTypeIcon || '';
            emojiEl.style.display = d.entryTypeIcon ? '' : 'none';
        } else {
            emojiEl.textContent = d.emoji || '';
            emojiEl.style.display = d.emoji ? '' : 'none';
        }
        document.getElementById('fd-title').textContent = d.title;

        // –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–∏–ø–∞ (–¥–ª—è –Ω–µ-event)
        var typeCardEl = document.getElementById('fd-type-card');
        if (entryType !== 'event') {
            var statusBadge = '';
            var ts = d.triggerStatus || 'pending';
            if (ts) {
                var statusClass = 'bee-cal-trigger-badge bee-cal-trigger-badge--' + escapeHtml(ts);
                statusBadge = '<span class="' + statusClass + '">' + escapeHtml(d.triggerStatusIcon) + ' ' + escapeHtml(ts) + '</span>';
            }
            typeCardEl.innerHTML = '<div class="bee-cal-fulldetail-type-card" style="border-left-color:' + typeColor + ';background:' + typeBg + '">' +
                '<div class="bee-cal-fulldetail-type-card-icon">' + escapeHtml(d.entryTypeIcon) + '</div>' +
                '<div class="bee-cal-fulldetail-type-card-body">' +
                '<div class="bee-cal-fulldetail-type-card-label">' + escapeHtml(d.entryTypeLabel) + '</div>' +
                '<div class="bee-cal-fulldetail-type-card-status">' + statusBadge + '</div>' +
                '</div></div>';
        } else {
            typeCardEl.innerHTML = '';
        }

        // –ë–µ–π–¥–∂–∏
        var badges = '';
        badges += '<span class="bee-badge" style="background:' + escapeHtml(d.priorityColor) + ';color:#fff;font-size:11px">' + escapeHtml(d.priorityLabel) + '</span>';
        if (d.status === 'done') badges += ' <span class="bee-badge bee-badge--success" style="font-size:11px">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>';
        else if (d.status === 'cancelled') badges += ' <span class="bee-badge bee-badge--error" style="font-size:11px">–û—Ç–º–µ–Ω–µ–Ω–æ</span>';
        else badges += ' <span class="bee-badge" style="font-size:11px">–ê–∫—Ç–∏–≤–Ω–æ</span>';
        if (d.ai === 'false') badges += ' <span class="bee-cal-ai-badge">AI OFF</span>';
        if (d.allDay === 'true') badges += ' <span class="bee-badge bee-badge--outline" style="font-size:11px">–í–µ—Å—å –¥–µ–Ω—å</span>';
        document.getElementById('fd-badges').innerHTML = badges;

        // –í—Ä–µ–º—è
        var timeStr = '';
        if (d.start) {
            var s = d.start.replace('T', ' ').slice(0, 16);
            timeStr = '&#128337; ' + s;
            if (d.end) timeStr += ' ‚Äî ' + d.end.replace('T', ' ').slice(0, 16);
        } else if (d.time) {
            timeStr = '&#128337; ' + d.time;
        }
        document.getElementById('fd-time').innerHTML = timeStr;
        document.getElementById('fd-time').style.display = timeStr ? '' : 'none';

        // Trigger-at (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ) + urgency
        var trigAtEl = document.getElementById('fd-trigger-at');
        if (d.triggerAtFull) {
            var urgentHtml = '';
            if (d.urgent === 'true') {
                urgentHtml = '<div style="color:#F59E0B;font-size:13px;font-weight:600;margin-bottom:4px">&#9889; –°—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∫–æ—Ä–æ!</div>';
            }
            trigAtEl.innerHTML = urgentHtml + '<div class="bee-cal-fulldetail-trigger-at">&#9200; –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ: ' + escapeHtml(d.triggerAtFull) + '</div>';
        } else {
            trigAtEl.innerHTML = '';
        }

        // Tick info (–º–æ–Ω–∏—Ç–æ—Ä—ã)
        var tickInfoEl = document.getElementById('fd-tick-info');
        if (d.tickInfo) {
            var tickHtml = '<div class="bee-cal-fulldetail-tick-info">&#128202; ' + escapeHtml(d.tickInfo);
            var tickCount = parseInt(d.tickCount) || 0;
            var maxTicks = parseInt(d.maxTicks) || 0;
            if (maxTicks > 0) {
                var pct = Math.min(100, Math.round(tickCount / maxTicks * 100));
                tickHtml += '<div class="bee-cal-fulldetail-tick-progress"><div class="bee-progress"><div class="bee-progress-fill" style="width:' + pct + '%"></div></div></div>';
            }
            tickHtml += '</div>';
            tickInfoEl.innerHTML = tickHtml;
        } else {
            tickInfoEl.innerHTML = '';
        }

        // –°–µ–∫—Ü–∏—è: –û–ø–∏—Å–∞–Ω–∏–µ
        if (d.desc) {
            document.getElementById('fd-desc').textContent = d.desc;
            showSection('fd-section-desc');
        }

        // –°–µ–∫—Ü–∏—è: –¢–µ–≥–∏
        var tags = d.tags ? d.tags.split(',').filter(function (t) { return t; }) : [];
        if (tags.length > 0) {
            var tagsHtml = '';
            for (var i = 0; i < tags.length; i++) {
                tagsHtml += '<span class="bee-cal-tag" data-tag="' + escapeHtml(tags[i]) + '" style="cursor:pointer">' + escapeHtml(tags[i]) + '</span> ';
            }
            document.getElementById('fd-tags').innerHTML = tagsHtml;
            var tagsCountEl = document.getElementById('fd-tags-count');
            if (tags.length > 3) {
                tagsCountEl.textContent = tags.length;
                tagsCountEl.classList.remove('hidden');
            } else {
                tagsCountEl.classList.add('hidden');
            }
            showSection('fd-section-tags');
        }

        // –°–µ–∫—Ü–∏—è: –í–∏–¥–∂–µ—Ç—ã
        var widgetsEl = document.getElementById('fd-widgets');
        var widgetsJson = d.widgetsJson || '';
        var hasWidgets = false;
        if (widgetsJson) {
            try {
                var widgetsList = JSON.parse(widgetsJson);
                if (widgetsList && widgetsList.length > 0) {
                    hasWidgets = true;
                    var wHtml = '';
                    for (var wi = 0; wi < widgetsList.length; wi++) {
                        var w = widgetsList[wi];
                        var wClass = 'bee-cal-widget bee-cal-widget--' + (w.type || 'rate');
                        if (w.change && w.change > 0) wClass += ' bee-cal-widget--up';
                        else if (w.change && w.change < 0) wClass += ' bee-cal-widget--down';
                        wHtml += '<span class="' + wClass + '" style="font-size:13px;padding:4px 10px">';
                        if (w.has_icon && w.icon_url) {
                            wHtml += '<img src="' + escapeHtml(w.icon_url) + '" alt="" width="14" height="14" class="bee-cal-widget-icon" loading="lazy" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'\'"><span style="display:none">' + escapeHtml(w.icon || '') + '</span> ';
                        } else {
                            wHtml += escapeHtml(w.icon || '') + ' ';
                        }
                        wHtml += escapeHtml(w.label || '') + ': <b>' + escapeHtml(w.value || '') + '</b>';
                        if (w.change) {
                            var sign = w.change > 0 ? '+' : '';
                            wHtml += ' <span class="bee-cal-widget-change">' + sign + w.change.toFixed(1) + '%</span>';
                        }
                        wHtml += '</span>';
                    }
                    widgetsEl.innerHTML = wHtml;
                }
            } catch (ex) {}
        }
        if (hasWidgets) showSection('fd-section-widgets');

        // –°–µ–∫—Ü–∏—è: –ê–≤—Ç–æ—Ä
        var creatorHtml = '';
        if (d.creatorType && d.creatorType !== 'unknown') {
            var typeLabel = d.creatorType === 'ai' ? '–ù–µ–π—Ä–æ—Å–µ—Ç—å' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            var cName = escapeHtml(d.creatorName || d.createdBy || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
            var pName = d.participantName || '';
            var namesDisplay = cName;
            if (pName) namesDisplay += ' –∏ ' + escapeHtml(pName);
            var creatorHasIcon = d.creatorHasIcon === 'true';
            var creatorIconUrl = d.creatorIconUrl || '';
            var creatorAvaContent;
            if (creatorHasIcon && creatorIconUrl) {
                creatorAvaContent = '<img src="' + escapeHtml(creatorIconUrl) + '" alt="" width="16" height="16" loading="lazy" style="display:block" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'\'"><span style="display:none">' + escapeHtml(d.creatorEmoji) + '</span>';
            } else {
                creatorAvaContent = escapeHtml(d.creatorEmoji);
            }
            var avasHtml = '<div class="bee-cal-event-avatars" style="margin-right:4px">' +
                '<div class="bee-cal-event-ava" style="background:' + escapeHtml(d.creatorColor) + ';width:28px;height:28px;font-size:14px">' + creatorAvaContent + '</div>';
            if (pName) {
                var pHasIcon = d.participantHasIcon === 'true';
                var pIconUrl = d.participantIconUrl || '';
                var pAvaContent;
                if (pHasIcon && pIconUrl) {
                    pAvaContent = '<img src="' + escapeHtml(pIconUrl) + '" alt="" width="16" height="16" loading="lazy" style="display:block" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'\'"><span style="display:none">' + escapeHtml(d.participantEmoji) + '</span>';
                } else {
                    pAvaContent = escapeHtml(d.participantEmoji);
                }
                avasHtml += '<div class="bee-cal-event-ava" style="background:' + escapeHtml(d.participantColor) + ';width:28px;height:28px;font-size:14px">' + pAvaContent + '</div>';
            }
            avasHtml += '</div>';
            creatorHtml = avasHtml +
                '<div><div class="bee-cal-creator-name">' + namesDisplay + '</div>' +
                '<div class="bee-cal-creator-type">' + typeLabel + '</div></div>';
        }
        var creatorEl = document.getElementById('fd-creator');
        creatorEl.innerHTML = creatorHtml;
        var hasCostSource = d.cost || d.sourceLabel;
        if (creatorHtml || hasCostSource) {
            showSection('fd-section-creator');
        }

        // Cost + Source (–≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ –ê–≤—Ç–æ—Ä)
        var costSourceEl = document.getElementById('fd-cost-source');
        var csHtml = '';
        if (hasCostSource) {
            csHtml = '<div class="bee-cal-fulldetail-cost-row" style="margin-top:8px">';
            if (d.cost) csHtml += '<span class="bee-cal-cost-badge">' + escapeHtml(d.cost) + '</span>';
            if (d.sourceLabel) csHtml += '<span class="bee-cal-source-badge">' + escapeHtml(d.sourceLabel) + '</span>';
            csHtml += '</div>';
        }
        costSourceEl.innerHTML = csHtml;

        // –°–µ–∫—Ü–∏—è: –î–µ–π—Å—Ç–≤–∏–µ
        var actionJson = d.actionJson || '';
        if (actionJson && actionJson !== '{}') {
            document.getElementById('fd-action').textContent = actionJson;
            showSection('fd-section-action');
        }

        // –°–µ–∫—Ü–∏—è: –†–µ–∑—É–ª—å—Ç–∞—Ç
        var resultJson = d.resultJson || '';
        if (resultJson && resultJson !== 'null') {
            var resultEl = document.getElementById('fd-result');
            resultEl.textContent = resultJson;
            var resultStatus = '';
            try {
                var rObj = JSON.parse(resultJson);
                resultStatus = rObj && rObj.status ? rObj.status : '';
            } catch (ex) {}
            resultEl.className = 'bee-fd-json';
            if (resultStatus === 'success') resultEl.className += ' bee-fd-json--success';
            else if (resultStatus === 'failed') resultEl.className += ' bee-fd-json--failed';
            showSection('fd-section-result');
        }

        // –°–µ–∫—Ü–∏—è: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)
        var meta = [];
        if (d.entryId) meta.push('ID: ' + d.entryId);
        if (d.createdBy) meta.push('created_by: ' + d.createdBy);
        if (d.sourceModule) meta.push('source: ' + d.sourceModule);
        if (entryType !== 'event') meta.push('type: ' + entryType);
        if (d.tickInfo) meta.push(d.tickInfo);
        document.getElementById('fd-meta').textContent = meta.join(' \u00B7 ');
        showSection('fd-section-meta');

        // –ê–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏
        var adminEl = document.getElementById('fd-admin');
        if (IS_ADMIN && adminEl) {
            adminEl.classList.remove('hidden');
            var doneBtn = document.getElementById('fd-done-btn');
            var delBtn = document.getElementById('fd-delete-btn');
            var eid = d.entryId;
            doneBtn.style.display = (d.status === 'done') ? 'none' : '';
            doneBtn.onclick = function () { triggerAction('done', eid); fulldetail.classList.add('hidden'); };
            delBtn.onclick = function () { triggerAction('delete', eid); fulldetail.classList.add('hidden'); };
        } else if (adminEl) {
            adminEl.classList.add('hidden');
        }

        fulldetail.classList.remove('hidden');
    }

    // ‚îÄ‚îÄ –ü–æ–∏—Å–∫ / —Ñ–∏–ª—å—Ç—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var searchOverlay = document.getElementById('search-overlay');
    var searchOpen = document.getElementById('search-open');
    var searchCloseBtn = document.getElementById('search-close');
    var searchText = document.getElementById('search-text');
    var searchCount = document.getElementById('search-count');

    var filters = { text: '', status: 'all', priority: 'all', tags: [], creator: 'all', entryType: 'all', creatorExact: '' };

    if (searchOpen) searchOpen.onclick = function () {
        searchOverlay.classList.remove('hidden');
        searchText.focus();
        haptic('impact', 'light');
    };
    if (searchCloseBtn) searchCloseBtn.onclick = function () {
        searchOverlay.classList.add('hidden');
    };

    // –ü–∏–ª—é–ª–∏ —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏
    setupPills('search-entry-type', function (val) { filters.entryType = val; });
    // –ü–∏–ª—é–ª–∏ —Å—Ç–∞—Ç—É—Å–∞
    setupPills('search-status', function (val) { filters.status = val; });
    // –ü–∏–ª—é–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    setupPills('search-priority', function (val) { filters.priority = val; });
    // –ü–∏–ª—é–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è
    setupPills('search-creator', function (val) { filters.creator = val; });

    function setupPills(containerId, onSelect) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.addEventListener('click', function (e) {
            var pill = e.target.closest('.bee-cal-search-pill');
            if (!pill) return;
            var pills = container.querySelectorAll('.bee-cal-search-pill');
            for (var i = 0; i < pills.length; i++) pills[i].classList.remove('bee-cal-search-pill--active');
            pill.classList.add('bee-cal-search-pill--active');
            onSelect(pill.getAttribute('data-val'));
            haptic('selection');
        });
    }

    // –¢–µ–≥–∏ (—á–µ–∫–±–æ–∫—Å—ã)
    var searchTagsEl = document.getElementById('search-tags');
    if (searchTagsEl) searchTagsEl.addEventListener('click', function (e) {
        var item = e.target.closest('.bee-cal-search-tag-item');
        if (!item) return;
        var tag = item.getAttribute('data-tag');
        item.classList.toggle('bee-cal-search-tag-item--active');
        var idx = filters.tags.indexOf(tag);
        if (idx >= 0) filters.tags.splice(idx, 1);
        else filters.tags.push(tag);
        haptic('selection');
    });

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    var applyBtn = document.getElementById('search-apply');
    if (applyBtn) applyBtn.onclick = function () {
        filters.text = (searchText ? searchText.value : '').toLowerCase().trim();
        applyFilters();
        searchOverlay.classList.add('hidden');
        haptic('notification', 'success');
    };

    // –°–±—Ä–æ—Å–∏—Ç—å
    var resetBtn = document.getElementById('search-reset');
    if (resetBtn) resetBtn.onclick = function () {
        filters = { text: '', status: 'all', priority: 'all', tags: [], creator: 'all', entryType: 'all', creatorExact: '' };
        if (searchText) searchText.value = '';
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∏–ª—é–ª–∏
        var allPills = searchOverlay.querySelectorAll('.bee-cal-search-pill');
        for (var i = 0; i < allPills.length; i++) {
            allPills[i].classList.toggle('bee-cal-search-pill--active', allPills[i].getAttribute('data-val') === 'all');
        }
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–≥–∏
        var tagItems = searchOverlay.querySelectorAll('.bee-cal-search-tag-item--active');
        for (var j = 0; j < tagItems.length; j++) tagItems[j].classList.remove('bee-cal-search-tag-item--active');
        applyFilters();
        haptic('selection');
    };

    function applyFilters() {
        var events = document.querySelectorAll('.bee-cal-event[data-entry-id]');
        var activeCount = 0;
        if (filters.entryType !== 'all') activeCount++;
        if (filters.status !== 'all') activeCount++;
        if (filters.priority !== 'all') activeCount++;
        if (filters.tags.length > 0) activeCount++;
        if (filters.text) activeCount++;
        if (filters.creator !== 'all') activeCount++;
        if (filters.creatorExact) activeCount++;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
        if (searchCount) {
            if (activeCount > 0) {
                searchCount.textContent = activeCount;
                searchCount.classList.remove('hidden');
            } else {
                searchCount.classList.add('hidden');
            }
        }

        for (var i = 0; i < events.length; i++) {
            var ev = events[i];
            var show = true;

            // –¢–∏–ø –∑–∞–ø–∏—Å–∏
            if (show && filters.entryType !== 'all') {
                if ((ev.getAttribute('data-entry-type') || 'event') !== filters.entryType) show = false;
            }
            // –¢–µ–∫—Å—Ç
            if (filters.text) {
                var title = (ev.getAttribute('data-title') || '').toLowerCase();
                var desc = (ev.getAttribute('data-desc') || '').toLowerCase();
                if (title.indexOf(filters.text) < 0 && desc.indexOf(filters.text) < 0) show = false;
            }
            // –°—Ç–∞—Ç—É—Å
            if (show && filters.status !== 'all') {
                if (ev.getAttribute('data-status') !== filters.status) show = false;
            }
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            if (show && filters.priority !== 'all') {
                if (ev.getAttribute('data-priority') !== filters.priority) show = false;
            }
            // –¢–µ–≥–∏
            if (show && filters.tags.length > 0) {
                var evTags = ev.getAttribute('data-tags') || '';
                var tagMatch = false;
                for (var j = 0; j < filters.tags.length; j++) {
                    if (evTags.indexOf(filters.tags[j]) >= 0) { tagMatch = true; break; }
                }
                if (!tagMatch) show = false;
            }
            // –°–æ–∑–¥–∞—Ç–µ–ª—å (—Ç–∏–ø)
            if (show && filters.creator !== 'all') {
                var cType = ev.getAttribute('data-creator-type') || '';
                if (cType !== filters.creator) show = false;
            }
            // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–∑–¥–∞—Ç–µ–ª—å (exact match)
            if (show && filters.creatorExact) {
                if ((ev.getAttribute('data-created-by') || '') !== filters.creatorExact) show = false;
            }

            ev.style.display = show ? '' : 'none';
        }
    }

    // ‚îÄ‚îÄ –ö–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä–∫–µ ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–≤—Ç–æ—Ä—É ‚îÄ‚îÄ
    document.addEventListener('click', function (e) {
        var ava = e.target.closest('.bee-cal-event-ava, .bee-cal-event-author-names');
        if (!ava) return;
        e.stopPropagation();
        var card = ava.closest('.bee-cal-event');
        if (!card) return;
        var createdBy = card.getAttribute('data-created-by');
        if (!createdBy) return;

        if (fulldetail && !fulldetail.classList.contains('hidden')) {
            fulldetail.classList.add('hidden');
        }

        filters = { text: '', status: 'all', priority: 'all', tags: [], creator: 'all', entryType: 'all', creatorExact: createdBy };
        applyFilters();
        var name = card.getAttribute('data-creator-name') || createdBy;
        showToast('–§–∏–ª—å—Ç—Ä: ' + name, 'success');
        haptic('selection');
    });

    // ‚îÄ‚îÄ –ö–ª–∏–∫ –ø–æ —Ç–µ–≥—É ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('click', function (e) {
        var tagEl = e.target.closest('.bee-cal-event-tag, #fd-tags .bee-cal-tag');
        if (!tagEl) return;
        e.stopPropagation();
        var tag = tagEl.getAttribute('data-tag');
        if (!tag) return;

        if (fulldetail && !fulldetail.classList.contains('hidden')) {
            fulldetail.classList.add('hidden');
        }

        filters.tags = [tag];
        filters.text = '';
        filters.status = 'all';
        filters.priority = 'all';
        filters.creator = 'all';
        filters.entryType = 'all';
        filters.creatorExact = '';
        applyFilters();
        showToast('–§–∏–ª—å—Ç—Ä: ' + tag, 'success');
        haptic('selection');
    });

    // ‚îÄ‚îÄ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-action]');
        if (!btn) return;
        var action = btn.getAttribute('data-action');
        var id = btn.getAttribute('data-entry-id');
        if (!id) return;
        e.stopPropagation();
        triggerAction(action, id);
    });

    // ‚îÄ‚îÄ –≠–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var emojiOverlay = document.getElementById('emoji-overlay');
    var emojiTrigger = document.getElementById('emoji-trigger');
    var emojiPreview = document.getElementById('emoji-preview');
    var emojiInput = document.getElementById('entry-emoji');
    var emojiClear = document.getElementById('emoji-clear');

    if (emojiOverlay) emojiOverlay.onclick = function (e) {
        if (e.target === emojiOverlay) emojiOverlay.classList.add('hidden');
    };
    if (emojiTrigger) emojiTrigger.onclick = function () {
        emojiOverlay.classList.remove('hidden');
        haptic('impact', 'light');
    };
    if (emojiClear) emojiClear.onclick = function () {
        emojiInput.value = '';
        emojiPreview.textContent = '–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏...';
        emojiOverlay.classList.add('hidden');
    };

    if (emojiOverlay) emojiOverlay.addEventListener('click', function (e) {
        var item = e.target.closest('.bee-cal-emoji-item');
        if (!item) return;
        var emoji = item.getAttribute('data-e');
        if (emoji && emojiInput) {
            emojiInput.value = emoji;
            emojiPreview.textContent = emoji + ' –≤—ã–±—Ä–∞–Ω–æ';
            emojiOverlay.classList.add('hidden');
            haptic('notification', 'success');
        }
    });

    // ‚îÄ‚îÄ –ê–¥–º–∏–Ω: CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (!IS_ADMIN) return;

    var fab = document.getElementById('fab-add');
    var overlay = document.getElementById('modal-overlay');
    var form = document.getElementById('entry-form');
    var entryTypeSelect = document.getElementById('entry-type');
    var triggerFields = document.getElementById('trigger-fields');
    var monitorFields = document.getElementById('monitor-fields');

    // –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è: –ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ —Ç–∏–ø—É –∑–∞–ø–∏—Å–∏
    function updateConditionalFields() {
        var et = entryTypeSelect ? entryTypeSelect.value : 'event';
        if (triggerFields) {
            triggerFields.classList.toggle('bee-cal-form-conditional--visible', et === 'trigger');
        }
        if (monitorFields) {
            monitorFields.classList.toggle('bee-cal-form-conditional--visible', et === 'monitor');
        }
    }

    if (entryTypeSelect) {
        entryTypeSelect.addEventListener('change', function () {
            updateConditionalFields();
            haptic('selection');
        });
    }

    if (fab) fab.onclick = function () {
        resetForm();
        document.getElementById('modal-title').textContent = '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ';
        document.getElementById('save-btn').textContent = '–°–æ–∑–¥–∞—Ç—å';
        overlay.classList.remove('hidden');
        haptic('impact', 'medium');
    };

    if (overlay) overlay.onclick = function (e) {
        if (e.target === overlay) overlay.classList.add('hidden');
    };

    if (form) form.onsubmit = function (e) {
        e.preventDefault();
        var btn = document.getElementById('save-btn');
        btn.disabled = true;

        var entryId = document.getElementById('entry-id').value;
        var tagsRaw = document.getElementById('entry-tags').value;
        var tags = tagsRaw ? tagsRaw.split(',').map(function (t) { return t.trim(); }).filter(Boolean) : [];
        var et = entryTypeSelect ? entryTypeSelect.value : 'event';

        var body = {
            title: document.getElementById('entry-title').value,
            description: document.getElementById('entry-desc').value || null,
            emoji: document.getElementById('entry-emoji').value || null,
            start_at: new Date(document.getElementById('entry-start').value).toISOString(),
            end_at: document.getElementById('entry-end').value ? new Date(document.getElementById('entry-end').value).toISOString() : null,
            priority: parseInt(document.getElementById('entry-priority').value),
            status: document.getElementById('entry-status').value,
            all_day: document.getElementById('entry-allday').checked,
            ai_actionable: document.getElementById('entry-ai').checked,
            tags: tags,
            entry_type: et,
            init_data: initData,
        };

        // –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
        if (et === 'trigger') {
            var trigAt = document.getElementById('entry-trigger-at').value;
            if (trigAt) body.trigger_at = new Date(trigAt).toISOString();
            body.action = { type: 'noop' };
        }

        // –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∞
        if (et === 'monitor') {
            body.tick_interval = document.getElementById('entry-tick-interval').value;
            var maxT = document.getElementById('entry-max-ticks').value;
            if (maxT) body.max_ticks = parseInt(maxT);
            body.action = { type: 'noop' };
        }

        var method, path;
        if (entryId) {
            method = 'PUT';
            path = '/p/' + PAGE_SLUG + '/calendar/entries/' + entryId;
        } else {
            method = 'POST';
            path = '/p/' + PAGE_SLUG + '/calendar/entries';
            body.calendar_id = CALENDAR_ID;
        }

        fetch(path, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
            .then(function (r) { return r.json(); })
            .then(function (result) {
                if (result.ok !== false && !result.detail) {
                    showToast(entryId ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ' : '–°–æ–∑–¥–∞–Ω–æ', 'success');
                    setTimeout(function () { location.reload(); }, 600);
                } else {
                    showToast(result.detail || '–û—à–∏–±–∫–∞', 'error');
                    btn.disabled = false;
                }
            })
            .catch(function () { showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); btn.disabled = false; });

        return false;
    };

    function resetForm() {
        document.getElementById('entry-id').value = '';
        document.getElementById('entry-emoji').value = '';
        document.getElementById('emoji-preview').textContent = '–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏...';
        document.getElementById('entry-title').value = '';
        document.getElementById('entry-desc').value = '';
        document.getElementById('entry-tags').value = '';
        document.getElementById('entry-priority').value = '3';
        document.getElementById('entry-status').value = 'active';
        document.getElementById('entry-allday').checked = false;
        document.getElementById('entry-ai').checked = true;
        if (entryTypeSelect) entryTypeSelect.value = 'event';
        if (document.getElementById('entry-trigger-at')) document.getElementById('entry-trigger-at').value = '';
        if (document.getElementById('entry-tick-interval')) document.getElementById('entry-tick-interval').value = '1h';
        if (document.getElementById('entry-max-ticks')) document.getElementById('entry-max-ticks').value = '';
        updateConditionalFields();
        var now = new Date();
        document.getElementById('entry-start').value = toLocalISO(now);
        document.getElementById('entry-end').value = '';
    }

    function toLocalISO(d) {
        return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) +
               'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }

    function pad(n) { return n < 10 ? '0' + n : '' + n; }
})();
</script>
{% endblock %}
