{# Карточка события v5 — 2-zone compact layout (include для calendar.html) #}
<div class="bee-cal-event bee-cal-event--clickable{% if e.entry_type and e.entry_type != 'event' %} bee-cal-event--{{ e.entry_type }}{% endif %}{% if not e.ai_actionable %} bee-cal-ai-off{% endif %}{% if e.status == 'done' %} bee-cal-event--done{% endif %}{% if e.status == 'cancelled' %} bee-cal-event--cancelled{% endif %}{% if e._urgent %} bee-cal-event--urgent{% endif %}"
     data-entry-id="{{ e.id }}"
     data-tags="{{ e._tags_lower }}"
     data-title="{{ e.title }}"
     data-desc="{{ e.description or '' }}"
     data-time="{{ e._time }}"
     data-priority="{{ e.priority }}"
     data-priority-label="{{ e._priority_label }}"
     data-priority-color="{{ e._priority_color }}"
     data-status="{{ e.status }}"
     data-color="{{ e._color }}"
     data-all-day="{{ 'true' if e.all_day else 'false' }}"
     data-ai="{{ 'true' if e.ai_actionable else 'false' }}"
     data-created-by="{{ e.created_by or '' }}"
     data-creator-type="{{ e._creator.type }}"
     data-creator-name="{{ e._creator.name }}"
     data-creator-emoji="{{ e._creator.emoji }}"
     data-creator-color="{{ e._creator.color }}"
     data-creator-has-icon="{{ 'true' if e._creator.has_icon else 'false' }}"
     data-creator-icon-url="{{ e._creator.icon_url }}"
     data-participant-type="{{ e._participant.type if e._participant else '' }}"
     data-participant-name="{{ e._participant.name if e._participant else '' }}"
     data-participant-emoji="{{ e._participant.emoji if e._participant else '' }}"
     data-participant-color="{{ e._participant.color if e._participant else '' }}"
     data-participant-has-icon="{{ 'true' if e._participant and e._participant.has_icon else 'false' }}"
     data-participant-icon-url="{{ e._participant.icon_url if e._participant and e._participant.icon_url else '' }}"
     data-emoji="{{ e.emoji or '' }}"
     data-icon="{{ e.icon or '' }}"
     data-icon-has="{{ 'true' if e._icon else 'false' }}"
     data-icon-url="{{ e._icon.icon_url if e._icon else '' }}"
     data-icon-color="{{ e._icon.icon_color if e._icon else '' }}"
     data-start="{{ e.start_at or '' }}"
     data-end="{{ e.end_at or '' }}"
     data-entry-type="{{ e.entry_type or 'event' }}"
     data-entry-type-color="{{ e._entry_type_color }}"
     data-trigger-status="{{ e.trigger_status or 'pending' }}"
     data-source-module="{{ e.source_module or '' }}"
     data-cost="{{ e._cost_display }}"
     data-entry-type-icon="{{ e._entry_type_icon }}"
     data-entry-type-label="{{ e._entry_type_label }}"
     data-trigger-status-icon="{{ e._trigger_status_icon }}"
     data-source-label="{{ e._source_label }}"
     data-action-json="{{ e._action_json | e }}"
     data-result-json="{{ e._result_json | e }}"
     data-trigger-at="{{ e.trigger_at or '' }}"
     data-trigger-at-full="{{ e._trigger_at_full }}"
     data-tick-info="{{ e._tick_info }}"
     data-tick-count="{{ e.tick_count or 0 }}"
     data-max-ticks="{{ e.max_ticks or '' }}"
     data-tick-interval="{{ e.tick_interval or '' }}"
     data-next-tick-at="{{ e.next_tick_at or '' }}"
     data-widgets-json="{{ e._widgets_json | e }}"
     data-urgent="{{ 'true' if e._urgent else 'false' }}">

    {# Левая полоска — тип/цвет, утолщённая для высокого приоритета #}
    {% if e.entry_type and e.entry_type != 'event' %}
    <div class="bee-cal-event-priority{% if e.priority >= 4 %} bee-cal-event-priority--high{% endif %}" style="background:{{ e._entry_type_color }}"></div>
    {% else %}
    <div class="bee-cal-event-priority{% if e.priority >= 4 %} bee-cal-event-priority--high{% endif %}" style="background:{{ e._color }}"></div>
    {% endif %}

    <div class="bee-cal-event-body">
        {# ── ZONE A: Identity ── #}
        <div class="bee-cal-event-head">
            {% if e._icon %}
            <span class="bee-cal-event-icon-inline" style="background:{{ e._icon.icon_color }}">
                <img src="{{ e._icon.icon_url }}" alt="" width="14" height="14" loading="lazy"
                     onerror="this.style.display='none';this.nextElementSibling.style.display=''">
                <span style="display:none">{{ e.emoji or e._entry_type_icon or '' }}</span>
            </span>
            {% elif e.emoji %}
            <span class="bee-cal-event-emoji-inline">{{ e.emoji }}</span>
            {% elif e.entry_type and e.entry_type != 'event' %}
            <span class="bee-cal-event-emoji-inline">{{ e._entry_type_icon }}</span>
            {% endif %}
            <span class="bee-cal-event-title{% if e.status == 'done' %} bee-cal-event-title--done{% endif %}">{{ e.title }}</span>
            {% if e.status == 'done' %}
            <span class="bee-cal-event-status-icon bee-cal-event-status-icon--done">&#10003;</span>
            {% elif e.status == 'cancelled' %}
            <span class="bee-cal-event-status-icon bee-cal-event-status-icon--cancelled">&#10005;</span>
            {% endif %}
            {% if e._time %}
            <span class="bee-cal-event-time">{{ e._time }}</span>
            {% endif %}
        </div>

        {% if e.description %}
        <div class="bee-cal-event-desc">{{ e.description }}</div>
        {% endif %}

        {# ── ZONE B: Context (single row) ── #}
        {% set has_ctx = (e._creator.type != 'unknown') or e._has_participant or e.tags or (e.entry_type in ('trigger', 'monitor')) %}
        {% if has_ctx %}
        <div class="bee-cal-event-ctx">
            {# Аватарки (max 2, без имён) #}
            {% if e._creator.type != 'unknown' or e._has_participant %}
            <div class="bee-cal-event-avatars">
                <div class="bee-cal-event-ava" style="background:{{ e._creator.color }}" title="{{ e._creator.name or e.created_by or '' }}">
                    {% if e._creator.has_icon %}
                    <img src="{{ e._creator.icon_url }}" alt="" width="14" height="14" loading="lazy"
                         onerror="this.style.display='none';this.nextElementSibling.style.display=''">
                    <span style="display:none">{{ e._creator.emoji }}</span>
                    {% else %}
                    {{ e._creator.emoji }}
                    {% endif %}
                </div>
                {% if e._has_participant %}
                <div class="bee-cal-event-ava" style="background:{{ e._participant.color }}" title="{{ e._participant.name }}">
                    {% if e._participant.has_icon %}
                    <img src="{{ e._participant.icon_url }}" alt="" width="14" height="14" loading="lazy"
                         onerror="this.style.display='none';this.nextElementSibling.style.display=''">
                    <span style="display:none">{{ e._participant.emoji }}</span>
                    {% else %}
                    {{ e._participant.emoji }}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            {# Теги (max 3 + overflow) #}
            {% if e.tags %}
            <div class="bee-cal-event-tags-compact">
                {% for tag in e.tags[:3] %}
                {% set tc = tag_colors.get(tag.lower(), 'var(--tg-hint)') if tag_colors else 'var(--tg-hint)' %}
                <span class="bee-cal-event-tag" data-tag="{{ tag | lower }}" style="color:{{ tc }}">{{ tag }}</span>
                {% endfor %}
                {% if e.tags | length > 3 %}
                <span class="bee-cal-event-tag-more">+{{ e.tags | length - 3 }}</span>
                {% endif %}
            </div>
            {% endif %}

            {# Type badge (trigger/monitor) #}
            {% if e.entry_type in ('trigger', 'monitor') %}
            <span class="bee-cal-trigger-badge bee-cal-trigger-badge--{{ e.trigger_status or 'pending' }}">{{ e._trigger_status_icon }} {{ e._entry_type_label }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {# Admin actions #}
    {% if is_admin %}
    <div class="bee-cal-event-actions">
        {% if e.status != 'done' %}
        <button class="bee-cal-event-action" title="Готово" data-action="done" data-entry-id="{{ e.id }}">&#10003;</button>
        {% endif %}
        <button class="bee-cal-event-action" title="Удалить" data-action="delete" data-entry-id="{{ e.id }}">&#10005;</button>
    </div>
    {% endif %}
</div>
