{% extends "base.html" %}

{% block title %}{{ page.title }}{% endblock %}

{% block bar_left %}<a class="bee-bar__back" href="/">&#8249;</a>{% endblock %}

{% block context %}
<div class="bee-card bee-hex-bg">
    <div class="bee-title">{{ page.title }}</div>
    {% if config.description %}
    <div class="bee-subtitle">{{ config.description }}</div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<form id="survey-form" onsubmit="return submitSurvey(event)">
    {% for field in config.get('fields', []) %}
    <div class="bee-field">
        <label class="bee-label">
            {{ field.label }}
            {% if field.get('required') %}<span class="required">*</span>{% endif %}
        </label>

        {% if field.type == 'text' %}
        <input type="text" name="{{ field.name }}" class="bee-input"
               {% if field.get('required') %}required{% endif %}
               {% if field.get('placeholder') %}placeholder="{{ field.placeholder }}"{% endif %}>

        {% elif field.type == 'textarea' %}
        <textarea name="{{ field.name }}" class="bee-textarea" rows="3"
                  {% if field.get('required') %}required{% endif %}
                  {% if field.get('placeholder') %}placeholder="{{ field.placeholder }}"{% endif %}></textarea>

        {% elif field.type == 'number' %}
        <input type="number" name="{{ field.name }}" class="bee-input"
               {% if field.get('required') %}required{% endif %}
               {% if field.get('min') is not none %}min="{{ field.min }}"{% endif %}
               {% if field.get('max') is not none %}max="{{ field.max }}"{% endif %}
               {% if field.get('placeholder') %}placeholder="{{ field.placeholder }}"{% endif %}>

        {% elif field.type == 'select' %}
        <select name="{{ field.name }}" class="bee-select"
                {% if field.get('required') %}required{% endif %}>
            <option value="">Выберите...</option>
            {% for opt in field.get('options', []) %}
            <option value="{{ opt.value if opt is mapping else opt }}">{{ opt.label if opt is mapping else opt }}</option>
            {% endfor %}
        </select>

        {% elif field.type == 'radio' %}
        <div class="bee-radio-group">
            {% for opt in field.get('options', []) %}
            <label class="bee-radio">
                <input type="radio" name="{{ field.name }}"
                       value="{{ opt.value if opt is mapping else opt }}"
                       {% if field.get('required') %}required{% endif %}>
                {{ opt.label if opt is mapping else opt }}
            </label>
            {% endfor %}
        </div>

        {% elif field.type == 'checkbox' %}
        <label class="bee-checkbox-label">
            <input type="checkbox" name="{{ field.name }}" value="true">
            {{ field.get('check_label', field.label) }}
        </label>
        {% endif %}
    </div>
    {% endfor %}

    <button type="submit" class="bee-btn mt-8" id="submit-btn">Отправить</button>
</form>

<!-- Результат -->
<div class="bee-result hidden" id="result-screen">
    <div class="bee-result-icon" id="result-icon"></div>
    <div class="bee-result-title" id="result-title"></div>
    <div class="bee-result-text" id="result-text"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var PAGE_SLUG = '{{ page.slug }}';

    function submitSurvey(e) {
        e.preventDefault();
        var btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.textContent = 'Отправка...';

        var form = document.getElementById('survey-form');
        var formData = new FormData(form);
        var data = {};
        formData.forEach(function (value, key) { data[key] = value; });

        fetch('/p/' + PAGE_SLUG + '/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                init_data: window.Telegram && window.Telegram.WebApp ? Telegram.WebApp.initData : '',
                data: data
            })
        })
        .then(function (resp) { return resp.json(); })
        .then(function (result) {
            if (result.ok) {
                form.classList.add('hidden');
                showResult('\u2705', 'Спасибо!', 'Ответ сохранён.');
                haptic('notification', 'success');
                setTimeout(function () {
                    if (window.Telegram && Telegram.WebApp) Telegram.WebApp.close();
                }, 2000);
            } else {
                showToast(result.detail || 'Ошибка отправки', 'error');
                btn.disabled = false;
                btn.textContent = 'Отправить';
            }
        })
        .catch(function () {
            showToast('Ошибка сети', 'error');
            btn.disabled = false;
            btn.textContent = 'Отправить';
        });

        return false;
    }

    function showResult(icon, title, text) {
        document.getElementById('result-icon').textContent = icon;
        document.getElementById('result-title').textContent = title;
        document.getElementById('result-text').textContent = text || '';
        document.getElementById('result-screen').classList.remove('hidden');
    }
</script>
{% endblock %}
